<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Last War Speed Calculator</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1620; --panel2:#0c121a; --border:#243244;
      --text:#e6eefc; --muted:#a7b3c7; --chip:#142235; --chip2:#0f1b2b;
      --accent:#66e3ff; --ok:#34d399;
    }
    * { box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 30% -10%, rgba(102,227,255,0.14), transparent 55%),
                  radial-gradient(900px 600px at 90% 0%, rgba(167,139,250,0.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:1100px; margin:28px auto; padding:0 14px; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    h1{ font-size:20px; margin:0; letter-spacing:0.2px; }
    .tiny{ font-size:12px; color:var(--muted); line-height:1.35; }
    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    button{
      background: linear-gradient(180deg, #1a2a3f, #132235);
      border:1px solid var(--border);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    button:hover{ border-color:#35506f; }
    button.secondary{ background: linear-gradient(180deg, #151b26, #101724); }
    button.danger{ background: linear-gradient(180deg, #3a1b22, #25131a); border-color:#5b2b35; }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0)),
                  var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .panel h2{ margin:0 0 10px 0; font-size:16px; display:flex; align-items:center; gap:10px; }
    .icon{
      width:34px; height:34px;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      border-radius:10px;
      background: var(--panel2);
      border:1px solid var(--border);
      padding:6px;
    }
    .miniIcon{
      width:22px; height:22px;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      display:inline-block;
      vertical-align:middle;
      margin-right:8px;
      border-radius:7px;
      background: rgba(0,0,0,0.18);
      border: 1px solid var(--border);
      padding:2px;
    }

    .row{ display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px; }
    @media (min-width: 700px){
      .row.cols2{ grid-template-columns: 1fr 1fr; }
      .row.cols3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: var(--panel2);
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus{ border-color:#3b5a7a; }

    .radioBox{
      display:grid; gap:8px; margin-top:10px;
      padding:10px; border-radius:14px; border:1px solid var(--border);
      background: rgba(0,0,0,0.15);
    }
    .radioRow{ display:flex; gap:10px; align-items:center; font-size:14px; }
    .radioRow input{ width:auto; }

    .checkRow{
      display:flex; gap:10px; align-items:center;
      margin-top:10px; padding:10px;
      border-radius:14px; border:1px solid var(--border);
      background: rgba(0,0,0,0.15);
    }
    .checkRow input{ width:auto; }

    .resultBox{
      margin-top:12px; padding:12px;
      border-radius:14px; border:1px solid var(--border);
      background: rgba(0,0,0,0.20);
    }
    .big{ font-size:18px; font-weight:800; margin:0 0 6px 0; }
    .sub{ font-size:13px; color:var(--muted); margin:0; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0)), var(--chip);
      font-size:12px; color: var(--text);
    }
    .pill strong{ color: var(--accent); }

    .chips{ margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background: var(--chip2);
      border:1px solid var(--border);
      font-size:12px; color:var(--text);
      white-space:nowrap;
    }
    .chip .k{ color:var(--muted); }
    .chip .v{ color:var(--ok); font-weight:800; }

    .compareGrid{ display:grid; grid-template-columns: 1fr; gap:14px; margin-top:14px; }
    @media (min-width: 960px){ .compareGrid{ grid-template-columns: 1fr 1fr; } }

    .two{ display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 960px){ .two{ grid-template-columns: 1fr 1fr; } }

    .note{
      margin-top:10px; padding:10px; border-radius:14px;
      border:1px dashed #33506f;
      color:var(--muted);
      background: rgba(102,227,255,0.06);
      font-size:12px; line-height:1.35;
    }
    .miniRow{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-top:10px;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px; padding:2px 6px;
      border:1px solid var(--border);
      border-radius:8px;
      background: rgba(0,0,0,0.25);
      color:var(--text);
    }
    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Last War ‚Ä¢ Build & Research Speed Calculator</h1>
        <div class="tiny">
          Formula: <span class="kbd">final = base √ó 100 / (100 + totalBuff)</span> ‚Ä¢ Time: <span class="kbd">days hh:mm:ss</span>
        </div>
      </div>
      <div class="btnrow">
        <button class="secondary" onclick="copySetup('A')">Copy A ‚Üí B</button>
        <button class="secondary" onclick="copySetup('B')">Copy B ‚Üí A</button>
        <button class="danger" onclick="resetAll()">Reset</button>
      </div>
    </div>

    <!-- GLOBAL (shared across A/B) -->
    <div class="panel">
      <h2>Global (shared)</h2>

      <div class="row cols3">
        <div>
          <label><img class="miniIcon" src="vip.png" alt="VIP" />VIP Level (1‚Äì18)</label>
          <select id="vipLevel" oninput="recalcAll()">
            <option value="0">None</option>
            <option value="1">VIP 1</option><option value="2">VIP 2</option><option value="3">VIP 3</option>
            <option value="4">VIP 4</option><option value="5">VIP 5</option><option value="6">VIP 6</option>
            <option value="7">VIP 7</option><option value="8">VIP 8</option><option value="9">VIP 9</option>
            <option value="10">VIP 10</option><option value="11">VIP 11</option><option value="12">VIP 12</option>
            <option value="13">VIP 13</option><option value="14">VIP 14</option><option value="15">VIP 15</option>
            <option value="16">VIP 16</option><option value="17">VIP 17</option><option value="18">VIP 18</option>
          </select>
        </div>

        <div class="checkRow">
          <input type="checkbox" id="efficientDev" oninput="recalcAll()" />
          <label for="efficientDev" style="margin:0;color:var(--text)">
            <img class="miniIcon" src="eff_dev.png" alt="Efficient Development" />
            Efficient Development (+10% to Building & Research)
          </label>
        </div>

        <div class="checkRow">
          <input type="checkbox" id="conquerorBonus" oninput="recalcAll()" />
          <label for="conquerorBonus" style="margin:0;color:var(--text)">
            üèÜ Conqueror Bonus (Office becomes 60/30, VP 25)
          </label>
        </div>
      </div>

      <div class="note">
        <b>Only Office + Co-ops are meant to change between A and B.</b><br>
        This page auto-syncs all other fields from A ‚Üí B and locks them in B.
      </div>
    </div>

    <!-- SETUPS -->
    <div class="compareGrid">
      <!-- SETUP A -->
      <div class="panel">
        <h2>Setup A</h2>

        <div class="radioBox">
          <div class="tiny" style="margin-bottom:4px;">üèõ Office (A)</div>
          <div class="radioRow"><input type="radio" name="officeA" id="A_officeNone" value="none" checked oninput="recalcAll()"><label for="A_officeNone" style="margin:0;color:var(--text)">None</label></div>
          <div class="radioRow"><input type="radio" name="officeA" id="A_officeDev" value="dev" oninput="recalcAll()"><label for="A_officeDev" style="margin:0;color:var(--text)">üî® Dev (Build primary / Research secondary)</label></div>
          <div class="radioRow"><input type="radio" name="officeA" id="A_officeSci" value="sci" oninput="recalcAll()"><label for="A_officeSci" style="margin:0;color:var(--text)">üß™ Sci (Research primary / Build secondary)</label></div>
          <div class="radioRow"><input type="radio" name="officeA" id="A_officeVP" value="vp" oninput="recalcAll()"><label for="A_officeVP" style="margin:0;color:var(--text)">‚≠ê VP (both)</label></div>
        </div>

        <div class="two">
          <!-- A Building -->
          <div class="panel" style="margin:0;">
            <h2><img class="icon" src="building.avif" alt="building" />Building</h2>

            <div class="row cols2">
              <div>
                <label>Base Time<br>(days hh:mm:ss)</label>
                <input id="A_buildBase" type="text" value="0 01:00:00" oninput="recalcAll()">
              </div>
              <div>
                <label>Co-op Construction (A)</label>
                <select id="A_coopBuild" oninput="recalcAll()">
                  <option value="0">Off (0%)</option>
                  <option value="10">10%</option>
                  <option value="20">20%</option>
                </select>
              </div>
            </div>

            <div class="row cols3">
              <div>
                <label>üèõ Eternal Pyramid</label>
                <select id="A_pyramidLevel" oninput="recalcAll()">
                  <option value="0">0 (0%)</option><option value="1">1 (5%)</option><option value="2">2 (10%)</option>
                  <option value="3">3 (15%)</option><option value="4">4 (25%)</option><option value="5">5 (35%)</option>
                  <option value="6">6 (45%)</option><option value="7">7 (55%)</option>
                </select>
              </div>
              <div>
                <label>ü§ù Alliance Tech: Quick Construction</label>
                <input id="A_quickConstructionLevel" type="number" min="0" max="10" value="0" oninput="recalcAll()">
              </div>
              <div>
                <label>üß© Commander Tech: Fast Builder</label>
                <select id="A_fastBuilderLevel" oninput="recalcAll()">
                  <option value="0">0 (0%)</option><option value="1">1 (5%)</option><option value="2">2 (10%)</option>
                  <option value="3">3 (15%)</option><option value="4">4 (25%)</option>
                </select>
              </div>
            </div>

            <div class="row cols2">
              <div><label>‚ûï Other Build Buff 1 (%)</label><input id="A_buildBuff1" type="number" value="0" oninput="recalcAll()"></div>
              <div><label>‚ûï Other Build Buff 2 (%)</label><input id="A_buildBuff2" type="number" value="0" oninput="recalcAll()"></div>
            </div>

            <div class="resultBox">
              <p class="big" id="A_buildFinal">Final: ‚Äî</p>
              <p class="sub">
                <span class="pill">Total Buff <strong id="A_buildTotal">‚Äî</strong></span>
                <span class="pill">Speed <strong id="A_buildSpeed">‚Äî</strong></span>
              </p>
              <div class="chips" id="A_buildChips"></div>
            </div>
          </div>

          <!-- A Research -->
          <div class="panel" style="margin:0;">
            <h2><img class="icon" src="research.avif" alt="research" />Research</h2>

            <div class="row cols2">
              <div>
                <label>Base Time<br>(days hh:mm:ss)</label>
                <input id="A_researchBase" type="text" value="0 01:00:00" oninput="recalcAll()">
              </div>
              <div>
                <label>Co-op Research (A)</label>
                <select id="A_coopResearch" oninput="recalcAll()">
                  <option value="0">Off (0%)</option>
                  <option value="10">10%</option>
                  <option value="20">20%</option>
                </select>
              </div>
            </div>

            <div class="row cols3">
              <div><label>üè¢ Research Center Level</label><input id="A_researchCenterLevel" type="number" min="0" max="30" value="0" oninput="recalcAll()"></div>
              <div><label>ü§ù Alliance Tech: Quick Research</label><input id="A_quickResearchLevel" type="number" min="0" max="10" value="0" oninput="recalcAll()"></div>
              <div>
                <label>üß© Commander Tech: Research Enhancement</label>
                <select id="A_researchEnhancementLevel" oninput="recalcAll()">
                  <option value="0">0 (0%)</option><option value="1">1 (10%)</option><option value="2">2 (20%)</option>
                  <option value="3">3 (30%)</option><option value="4">4 (50%)</option>
                </select>
              </div>
            </div>

            <div class="row cols2">
              <div><label>üßç Survivor 1</label><select id="A_survivor1" oninput="recalcAll()"></select></div>
              <div><label>üßç Survivor 2</label><select id="A_survivor2" oninput="recalcAll()"></select></div>
            </div>
            <div class="row cols2">
              <div><label>üßç Survivor 3</label><select id="A_survivor3" oninput="recalcAll()"></select></div>
              <div><label>üßç Survivor 4</label><select id="A_survivor4" oninput="recalcAll()"></select></div>
            </div>

            <div class="row cols2">
              <div><label>‚ûï Other Res Buff 1 (%)</label><input id="A_researchBuff1" type="number" value="0" oninput="recalcAll()"></div>
              <div><label>‚ûï Other Res Buff 2 (%)</label><input id="A_researchBuff2" type="number" value="0" oninput="recalcAll()"></div>
            </div>

            <div class="resultBox">
              <p class="big" id="A_researchFinal">Final: ‚Äî</p>
              <p class="sub">
                <span class="pill">Total Buff <strong id="A_researchTotal">‚Äî</strong></span>
                <span class="pill">Speed <strong id="A_researchSpeed">‚Äî</strong></span>
              </p>
              <div class="chips" id="A_researchChips"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- SETUP B -->
      <div class="panel">
        <h2>Setup B</h2>

        <div class="radioBox">
          <div class="tiny" style="margin-bottom:4px;">üèõ Office (B)</div>
          <div class="radioRow"><input type="radio" name="officeB" id="B_officeNone" value="none" checked oninput="recalcAll()"><label for="B_officeNone" style="margin:0;color:var(--text)">None</label></div>
          <div class="radioRow"><input type="radio" name="officeB" id="B_officeDev" value="dev" oninput="recalcAll()"><label for="B_officeDev" style="margin:0;color:var(--text)">üî® Dev (Build primary / Research secondary)</label></div>
          <div class="radioRow"><input type="radio" name="officeB" id="B_officeSci" value="sci" oninput="recalcAll()"><label for="B_officeSci" style="margin:0;color:var(--text)">üß™ Sci (Research primary / Build secondary)</label></div>
          <div class="radioRow"><input type="radio" name="officeB" id="B_officeVP" value="vp" oninput="recalcAll()"><label for="B_officeVP" style="margin:0;color:var(--text)">‚≠ê VP (both)</label></div>
        </div>

        <div class="two">
          <!-- B Building -->
          <div class="panel" style="margin:0;">
            <h2><img class="icon" src="building.avif" alt="building" />Building</h2>

            <div class="row cols2">
              <div>
                <label>Base Time<br>(days hh:mm:ss)</label>
                <input id="B_buildBase" type="text" value="0 01:00:00" oninput="recalcAll()">
              </div>
              <div>
                <label>Co-op Construction (B)</label>
                <select id="B_coopBuild" oninput="recalcAll()">
                  <option value="0">Off (0%)</option>
                  <option value="10">10%</option>
                  <option value="20">20%</option>
                </select>
              </div>
            </div>

            <div class="row cols3">
              <div>
                <label>üèõ Eternal Pyramid</label>
                <select id="B_pyramidLevel" oninput="recalcAll()">
                  <option value="0">0 (0%)</option><option value="1">1 (5%)</option><option value="2">2 (10%)</option>
                  <option value="3">3 (15%)</option><option value="4">4 (25%)</option><option value="5">5 (35%)</option>
                  <option value="6">6 (45%)</option><option value="7">7 (55%)</option>
                </select>
              </div>
              <div><label>ü§ù Alliance Tech: Quick Construction</label><input id="B_quickConstructionLevel" type="number" min="0" max="10" value="0" oninput="recalcAll()"></div>
              <div>
                <label>üß© Commander Tech: Fast Builder</label>
                <select id="B_fastBuilderLevel" oninput="recalcAll()">
                  <option value="0">0 (0%)</option><option value="1">1 (5%)</option><option value="2">2 (10%)</option>
                  <option value="3">3 (15%)</option><option value="4">4 (25%)</option>
                </select>
              </div>
            </div>

            <div class="row cols2">
              <div><label>‚ûï Other Build Buff 1 (%)</label><input id="B_buildBuff1" type="number" value="0" oninput="recalcAll()"></div>
              <div><label>‚ûï Other Build Buff 2 (%)</label><input id="B_buildBuff2" type="number" value="0" oninput="recalcAll()"></div>
            </div>

            <div class="resultBox">
              <p class="big" id="B_buildFinal">Final: ‚Äî</p>
              <p class="sub">
                <span class="pill">Total Buff <strong id="B_buildTotal">‚Äî</strong></span>
                <span class="pill">Speed <strong id="B_buildSpeed">‚Äî</strong></span>
              </p>
              <div class="chips" id="B_buildChips"></div>
            </div>
          </div>

          <!-- B Research -->
          <div class="panel" style="margin:0;">
            <h2><img class="icon" src="research.avif" alt="research" />Research</h2>

            <div class="row cols2">
              <div>
                <label>Base Time<br>(days hh:mm:ss)</label>
                <input id="B_researchBase" type="text" value="0 01:00:00" oninput="recalcAll()">
              </div>
              <div>
                <label>Co-op Research (B)</label>
                <select id="B_coopResearch" oninput="recalcAll()">
                  <option value="0">Off (0%)</option>
                  <option value="10">10%</option>
                  <option value="20">20%</option>
                </select>
              </div>
            </div>

            <div class="row cols3">
              <div><label>üè¢ Research Center Level</label><input id="B_researchCenterLevel" type="number" min="0" max="30" value="0" oninput="recalcAll()"></div>
              <div><label>ü§ù Alliance Tech: Quick Research</label><input id="B_quickResearchLevel" type="number" min="0" max="10" value="0" oninput="recalcAll()"></div>
              <div>
                <label>üß© Commander Tech: Research Enhancement</label>
                <select id="B_researchEnhancementLevel" oninput="recalcAll()">
                  <option value="0">0 (0%)</option><option value="1">1 (10%)</option><option value="2">2 (20%)</option>
                  <option value="3">3 (30%)</option><option value="4">4 (50%)</option>
                </select>
              </div>
            </div>

            <div class="row cols2">
              <div><label>üßç Survivor 1</label><select id="B_survivor1" oninput="recalcAll()"></select></div>
              <div><label>üßç Survivor 2</label><select id="B_survivor2" oninput="recalcAll()"></select></div>
            </div>
            <div class="row cols2">
              <div><label>üßç Survivor 3</label><select id="B_survivor3" oninput="recalcAll()"></select></div>
              <div><label>üßç Survivor 4</label><select id="B_survivor4" oninput="recalcAll()"></select></div>
            </div>

            <div class="row cols2">
              <div><label>‚ûï Other Res Buff 1 (%)</label><input id="B_researchBuff1" type="number" value="0" oninput="recalcAll()"></div>
              <div><label>‚ûï Other Res Buff 2 (%)</label><input id="B_researchBuff2" type="number" value="0" oninput="recalcAll()"></div>
            </div>

            <div class="resultBox">
              <p class="big" id="B_researchFinal">Final: ‚Äî</p>
              <p class="sub">
                <span class="pill">Total Buff <strong id="B_researchTotal">‚Äî</strong></span>
                <span class="pill">Speed <strong id="B_researchSpeed">‚Äî</strong></span>
              </p>
              <div class="chips" id="B_researchChips"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Comparison -->
    <div class="panel" style="margin-top:14px;">
      <h2>Comparison</h2>
      <div class="row cols2">
        <div class="resultBox">
          <p class="big">Building: A vs B</p>
          <p class="sub">
            <span class="pill">A <strong id="cmp_buildA">‚Äî</strong></span>
            <span class="pill">B <strong id="cmp_buildB">‚Äî</strong></span>
            <span class="pill">Œî <strong id="cmp_buildDelta">‚Äî</strong></span>
          </p>
        </div>
        <div class="resultBox">
          <p class="big">Research: A vs B</p>
          <p class="sub">
            <span class="pill">A <strong id="cmp_resA">‚Äî</strong></span>
            <span class="pill">B <strong id="cmp_resB">‚Äî</strong></span>
            <span class="pill">Œî <strong id="cmp_resDelta">‚Äî</strong></span>
          </p>
        </div>
      </div>
      <div class="miniRow">
        <div class="tiny">Œî shows ‚ÄúB minus A‚Äù (negative means B is faster).</div>
        <button class="secondary" onclick="copyResultsToClipboard()">Copy Results Summary</button>
      </div>
    </div>

    <!-- Appointment Planner -->
    <div class="panel" style="margin-top:14px;">
      <h2>Appointment Planner (Server Time GMT-2)</h2>

      <div class="row cols2">
        <div>
          <label>Use Setup</label>
          <select id="appt_setup" oninput="recalcAll()">
            <option value="A">Setup A</option>
            <option value="B">Setup B</option>
          </select>
        </div>

        <div>
          <label>Type</label>
          <select id="appt_type" oninput="recalcAll()">
            <option value="build">Building</option>
            <option value="research">Research</option>
          </select>
        </div>
      </div>

      <div class="row cols2">
        <div>
          <label>Appointment Start (Server Time, GMT-2)<br><span class="tiny">Format: YYYY-MM-DD HH:MM:SS</span></label>
          <input id="appt_start" type="text" value="2026-02-13 06:52:36" oninput="recalcAll()">
        </div>

        <div id="appt_officeWrap">
          <label>Office Available At (Server Time, GMT-2)<br><span class="tiny">Required if an office is selected for the chosen setup</span></label>
          <input id="appt_officeAt" type="text" value="" placeholder="2026-02-13 07:00:00" oninput="recalcAll()">
        </div>
      </div>

      <div class="resultBox">
        <p class="big" id="appt_finish">Finish (Server Time): ‚Äî</p>
        <p class="sub">
          <span class="pill">Wait <strong id="appt_wait">‚Äî</strong></span>
          <span class="pill">Start <strong id="appt_effStart">‚Äî</strong></span>
          <span class="pill">Buffed Duration <strong id="appt_duration">‚Äî</strong></span>
        </p>
        <div class="chips" id="appt_chips"></div>
      </div>

      <div class="note">
        Office buffs apply only if the office is active when you START the task (not phased).
        This planner will automatically wait until the office time if an office is selected.
      </div>
    </div>
  </div>

<script>
  // ===== Survivor dropdown options =====
  const survivorOptions = [
    ["None","None (0%)"], ["N","N (4%)"], ["R","R (8%)"], ["SR","SR (12%)"], ["SSR","SSR (16%)"], ["UR","UR (25%)"]
  ];
  function fillSurvivorSelect(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = survivorOptions.map(([v,t]) => `<option value="${v}">${t}</option>`).join("");
  }
  ["A_survivor1","A_survivor2","A_survivor3","A_survivor4","B_survivor1","B_survivor2","B_survivor3","B_survivor4"].forEach(fillSurvivorSelect);

  // ===== Mappings =====
  function getVipBuildBonus(level){
    if (level > 10) return 50;
    if (level > 8) return 40;
    if (level > 6) return 30;
    if (level > 4) return 20;
    if (level > 3) return 10;
    return 0;
  }
  function getVipResearchBonus(level){
    if (level > 17) return 30;
    if (level > 14) return 25;
    if (level > 12) return 20;
    if (level > 10) return 15;
    if (level > 8) return 10;
    if (level > 6) return 5;
    return 0;
  }

  // Conqueror Bonus affects office values:
  // normal: primary 50 / secondary 25 / VP 20
  // conqueror: primary 60 / secondary 30 / VP 25
  function getOfficeBonuses(office, conquerorOn){
    const primary = conquerorOn ? 60 : 50;
    const secondary = conquerorOn ? 30 : 25;
    const vp = conquerorOn ? 25 : 20;

    if (office === "dev") return { build: primary, research: secondary };
    if (office === "sci") return { build: secondary, research: primary };
    if (office === "vp")  return { build: vp, research: vp };
    return { build: 0, research: 0 };
  }

  // Building
  function getEternalPyramidBonus(level){
    const map = {0:0,1:5,2:10,3:15,4:25,5:35,6:45,7:55};
    return map[level] ?? 0;
  }
  function getFastBuilderBonus(level){
    const map = {0:0,1:5,2:10,3:15,4:25};
    return map[level] ?? 0;
  }
  function getQuickConstructionBonus(level){
    level = clampNum(level, 0, 10);
    return level * 2.5;
  }

  // Research
  function getResearchCenterBonus(level){
    level = clampNum(level, 0, 30);
    return level / 2;
  }
  function getQuickResearchBonus(level){
    level = clampNum(level, 0, 10);
    return level * 2.5;
  }
  function getResearchEnhancementBonus(level){
    const map = {0:0,1:10,2:20,3:30,4:50};
    return map[level] ?? 0;
  }
  function getSurvivorBonus(rank){
    const map = { "UR":25, "SSR":16, "SR":12, "R":8, "N":4, "None":0 };
    return map[rank] ?? 0;
  }

  // ===== Math/time helpers =====
  function clampNum(n, min, max){
    n = Number(n);
    if (Number.isNaN(n)) n = 0;
    return Math.max(min, Math.min(max, n));
  }
  function applyBuffFormula(baseSeconds, totalBuffPct){
    if (baseSeconds <= 0) return 0;
    if (totalBuffPct <= -99.999) return Infinity;
    return baseSeconds * 100 / (100 + totalBuffPct);
  }
  function speedMultiplier(totalBuffPct){ return (100 + totalBuffPct) / 100; }

  function parseTimeInput(str){
    if (!str) return 0;
    str = String(str).trim();
    let days = 0;
    let timePart = str;

    if (str.includes(" ")) {
      const parts = str.split(/\s+/);
      days = parseFloat(parts[0]) || 0;
      timePart = parts[1] || "0:0:0";
    }
    const t = timePart.split(":");
    const h = parseFloat(t[0]) || 0;
    const m = parseFloat(t[1]) || 0;
    const s = parseFloat(t[2]) || 0;

    return (days * 86400) + (h * 3600) + (m * 60) + s;
  }

  function formatTime(seconds){
    if (!isFinite(seconds)) return "‚àû";
    seconds = Math.max(0, Math.floor(seconds));
    const days = Math.floor(seconds / 86400);
    seconds %= 86400;
    const hours = Math.floor(seconds / 3600);
    seconds %= 3600;
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${days} ${String(hours).padStart(2,"0")}:${String(minutes).padStart(2,"0")}:${String(secs).padStart(2,"0")}`;
  }

  function formatDeltaSeconds(delta){
    if (!isFinite(delta)) return "‚àû";
    const sign = delta < 0 ? "-" : "+";
    return `${sign}${formatTime(Math.abs(delta))}`;
  }

  // ===== Server time helpers (GMT-2) =====
  const SERVER_TZ_OFFSET = "-02:00"; // Server Time = GMT-2

  function parseServerDateTime(str){
    if (!str) return null;
    str = String(str).trim();
    if (!str) return null;

    const iso = str.replace(" ", "T");
    const hasSeconds = iso.match(/T\d\d:\d\d:\d\d$/);
    const isoFixed = hasSeconds ? iso : (iso.match(/T\d\d:\d\d$/) ? (iso + ":00") : iso);

    const d = new Date(isoFixed + SERVER_TZ_OFFSET);
    return isNaN(d.getTime()) ? null : d;
  }

  function formatServerDateTime(d){
    if (!d || isNaN(d.getTime())) return "‚Äî";
    const ms = d.getTime();

    // Offset -02:00 => server wall time = UTC - 2h
    const serverMs = ms - (2 * 3600 * 1000);
    const sd = new Date(serverMs);

    const Y = sd.getUTCFullYear();
    const M = String(sd.getUTCMonth()+1).padStart(2,"0");
    const D = String(sd.getUTCDate()).padStart(2,"0");
    const h = String(sd.getUTCHours()).padStart(2,"0");
    const m = String(sd.getUTCMinutes()).padStart(2,"0");
    const s = String(sd.getUTCSeconds()).padStart(2,"0");
    return `${Y}-${M}-${D} ${h}:${m}:${s}`;
  }

  // ===== UI helpers =====
  function chip(label, pct){
    if (!pct) return "";
    const shown = Number.isInteger(pct) ? pct.toString() : pct.toFixed(2);
    return `<span class="chip"><span class="k">${label}</span><span class="v">+${shown}%</span></span>`;
  }
  function setText(id, txt){ const el = document.getElementById(id); if (el) el.textContent = txt; }
  function setHTML(id, html){ const el = document.getElementById(id); if (el) el.innerHTML = html; }
  function getVal(id){ const el = document.getElementById(id); return el ? el.value : ""; }
  function getNum(id){ const v = parseFloat(getVal(id)); return Number.isFinite(v) ? v : 0; }
  function showEl(id, show){
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle("hidden", !show);
  }

  function getSelectedOffice(prefix){
    const checked = document.querySelector(`input[name="office${prefix}"]:checked`);
    return checked ? checked.value : "none";
  }

  // ===== Only Office + Co-ops are dynamic in B =====
  const DYNAMIC_B_IDS = new Set([
    "B_coopBuild",
    "B_coopResearch",
    "B_officeNone",
    "B_officeDev",
    "B_officeSci",
    "B_officeVP"
  ]);

  // Everything else in Setup B is forced to match Setup A:
  const SYNC_KEYS_A_TO_B = [
    "buildBase","researchBase",
    "pyramidLevel","quickConstructionLevel","fastBuilderLevel","buildBuff1","buildBuff2",
    "researchCenterLevel","quickResearchLevel","researchEnhancementLevel",
    "survivor1","survivor2","survivor3","survivor4",
    "researchBuff1","researchBuff2"
  ];

  function syncAtoBSharedFields(){
    for (const key of SYNC_KEYS_A_TO_B){
      const a = document.getElementById(`A_${key}`);
      const b = document.getElementById(`B_${key}`);
      if (a && b) b.value = a.value;
    }
  }

  function lockBSharedInputs(){
    const allB = document.querySelectorAll('[id^="B_"]');
    allB.forEach(el => {
      if (DYNAMIC_B_IDS.has(el.id)) {
        el.disabled = false;
        el.style.opacity = "1";
        return;
      }
      el.disabled = true;
      el.style.opacity = "0.65";
    });
  }

  // ===== Calculation per setup =====
  function calcSetup(prefix){
    const vip = parseInt(getVal("vipLevel")) || 0;
    const efficient = document.getElementById("efficientDev").checked ? 10 : 0;
    const conquerorOn = document.getElementById("conquerorBonus").checked;

    const officeKey = getSelectedOffice(prefix);
    const officeBonus = getOfficeBonuses(officeKey, conquerorOn);

    // Building
    const buildBase = parseTimeInput(getVal(`${prefix}_buildBase`));
    const buildVip = getVipBuildBonus(vip);
    const coopBuild = getNum(`${prefix}_coopBuild`);
    const pyramidBuff = getEternalPyramidBonus(parseInt(getVal(`${prefix}_pyramidLevel`)) || 0);
    const quickConstructionBuff = getQuickConstructionBonus(getNum(`${prefix}_quickConstructionLevel`));
    const fastBuilderBuff = getFastBuilderBonus(parseInt(getVal(`${prefix}_fastBuilderLevel`)) || 0);
    const buildOther1 = getNum(`${prefix}_buildBuff1`);
    const buildOther2 = getNum(`${prefix}_buildBuff2`);

    const buildTotal =
      buildVip + officeBonus.build + efficient + coopBuild +
      pyramidBuff + quickConstructionBuff + fastBuilderBuff +
      buildOther1 + buildOther2;

    const buildFinal = applyBuffFormula(buildBase, buildTotal);

    // Research
    const researchBase = parseTimeInput(getVal(`${prefix}_researchBase`));
    const researchVip = getVipResearchBonus(vip);
    const coopResearch = getNum(`${prefix}_coopResearch`);
    const researchCenterBuff = getResearchCenterBonus(getNum(`${prefix}_researchCenterLevel`));
    const quickResearchBuff = getQuickResearchBonus(getNum(`${prefix}_quickResearchLevel`));
    const researchEnhBuff = getResearchEnhancementBonus(parseInt(getVal(`${prefix}_researchEnhancementLevel`)) || 0);

    const s1 = getSurvivorBonus(getVal(`${prefix}_survivor1`));
    const s2 = getSurvivorBonus(getVal(`${prefix}_survivor2`));
    const s3 = getSurvivorBonus(getVal(`${prefix}_survivor3`));
    const s4 = getSurvivorBonus(getVal(`${prefix}_survivor4`));

    const researchOther1 = getNum(`${prefix}_researchBuff1`);
    const researchOther2 = getNum(`${prefix}_researchBuff2`);

    const researchTotal =
      researchVip + officeBonus.research + efficient + coopResearch +
      researchCenterBuff + quickResearchBuff + researchEnhBuff +
      s1 + s2 + s3 + s4 +
      researchOther1 + researchOther2;

    const researchFinal = applyBuffFormula(researchBase, researchTotal);

    return {
      officeKey,
      build: { total: buildTotal, final: buildFinal },
      research: { total: researchTotal, final: researchFinal },
      breakdown: {
        buildVip, officeBuild: officeBonus.build, efficient, coopBuild, pyramidBuff, quickConstructionBuff, fastBuilderBuff, buildOther1, buildOther2,
        researchVip, officeResearch: officeBonus.research, coopResearch, researchCenterBuff, quickResearchBuff, researchEnhBuff, s1,s2,s3,s4, researchOther1, researchOther2
      }
    };
  }

  function render(prefix, data){
    // Building
    setText(`${prefix}_buildFinal`, `Final: ${formatTime(data.build.final)}`);
    setText(`${prefix}_buildTotal`, `+${data.build.total.toFixed(2)}%`);
    setText(`${prefix}_buildSpeed`, `${speedMultiplier(data.build.total).toFixed(2)}x`);

    const b = data.breakdown;
    const buildChips =
      chip("üëë VIP", b.buildVip) +
      chip("üèõ Office", b.officeBuild) +
      chip("üß† Efficient", b.efficient) +
      chip("ü§ù Co-op", b.coopBuild) +
      chip("üèõ Pyramid", b.pyramidBuff) +
      chip("ü§ù Quick Constr", b.quickConstructionBuff) +
      chip("üß© Fast Builder", b.fastBuilderBuff) +
      chip("‚ûï Other 1", b.buildOther1) +
      chip("‚ûï Other 2", b.buildOther2);
    setHTML(`${prefix}_buildChips`, buildChips || `<span class="tiny">No buffs selected.</span>`);

    // Research
    setText(`${prefix}_researchFinal`, `Final: ${formatTime(data.research.final)}`);
    setText(`${prefix}_researchTotal`, `+${data.research.total.toFixed(2)}%`);
    setText(`${prefix}_researchSpeed`, `${speedMultiplier(data.research.total).toFixed(2)}x`);

    const researchChips =
      chip("üëë VIP", b.researchVip) +
      chip("üèõ Office", b.officeResearch) +
      chip("üß† Efficient", b.efficient) +
      chip("ü§ù Co-op", b.coopResearch) +
      chip("üè¢ Res Ctr", b.researchCenterBuff) +
      chip("ü§ù Quick Res", b.quickResearchBuff) +
      chip("üß© Res Enhance", b.researchEnhBuff) +
      chip("üßç S1", b.s1) + chip("üßç S2", b.s2) + chip("üßç S3", b.s3) + chip("üßç S4", b.s4) +
      chip("‚ûï Other 1", b.researchOther1) +
      chip("‚ûï Other 2", b.researchOther2);
    setHTML(`${prefix}_researchChips`, researchChips || `<span class="tiny">No buffs selected.</span>`);
  }

  // ===== Appointment Planner (not phased; office must be active at start) =====
  function updateAppointmentPlanner(){
    const setup = getVal("appt_setup") || "A";
    const type = getVal("appt_type") || "build";

    const start = parseServerDateTime(getVal("appt_start"));
    const officeAt = parseServerDateTime(getVal("appt_officeAt"));

    const data = calcSetup(setup);
    const officeKey = data.officeKey; // none/dev/sci/vp

    // Hide office input unless an office is selected
    showEl("appt_officeWrap", officeKey !== "none");

    if (!start){
      setText("appt_finish", "Finish (Server Time): ‚Äî");
      setText("appt_wait", "‚Äî");
      setText("appt_effStart", "‚Äî");
      setText("appt_duration", "‚Äî");
      setHTML("appt_chips", `<span class="tiny">Enter a valid Appointment Start time.</span>`);
      return;
    }

    // Required if office selected
    if (officeKey !== "none" && !officeAt){
      setText("appt_finish", "Finish (Server Time): ‚Äî");
      setText("appt_wait", "‚Äî");
      setText("appt_effStart", "‚Äî");
      setText("appt_duration", "‚Äî");
      setHTML("appt_chips", `<span class="tiny">Office is selected (${officeKey.toUpperCase()}), so ‚ÄúOffice Available At‚Äù is required.</span>`);
      return;
    }

    // Buffed duration seconds depends on type
    const buffedSeconds = (type === "research") ? data.research.final : data.build.final;

    // If office selected and officeAt is after start, you must wait (not phased)
    let effectiveStart = start;
    let waitSeconds = 0;

    if (officeKey !== "none" && officeAt.getTime() > start.getTime()){
      waitSeconds = Math.floor((officeAt.getTime() - start.getTime()) / 1000);
      effectiveStart = officeAt;
    }

    const finish = new Date(effectiveStart.getTime() + (buffedSeconds * 1000));

    setText("appt_finish", `Finish (Server Time): ${formatServerDateTime(finish)}`);
    setText("appt_wait", formatTime(waitSeconds));
    setText("appt_effStart", formatServerDateTime(effectiveStart));
    setText("appt_duration", formatTime(buffedSeconds));

    const pct = (type === "research") ? data.research.total : data.build.total;
    const mult = speedMultiplier(pct).toFixed(2);

    const chips =
      `<span class="chip"><span class="k">Using</span><span class="v">${setup} / ${type}</span></span>` +
      `<span class="chip"><span class="k">Office</span><span class="v">${officeKey.toUpperCase()}</span></span>` +
      `<span class="chip"><span class="k">Total Buff</span><span class="v">+${pct.toFixed(2)}%</span></span>` +
      `<span class="chip"><span class="k">Speed</span><span class="v">${mult}x</span></span>` +
      `<span class="chip"><span class="k">Wait</span><span class="v">${formatTime(waitSeconds)}</span></span>`;
    setHTML("appt_chips", chips);
  }

  // ===== Auto-save =====
  const STORAGE_KEY = "lw_speed_calc_v5";

  function collectState(){
    const ids = [
      "vipLevel","efficientDev","conquerorBonus",

      // Appointment Planner
      "appt_setup","appt_type","appt_start","appt_officeAt",

      // Offices per-setup
      "A_officeNone","A_officeDev","A_officeSci","A_officeVP",
      "B_officeNone","B_officeDev","B_officeSci","B_officeVP",

      // A
      "A_buildBase","A_coopBuild","A_pyramidLevel","A_quickConstructionLevel","A_fastBuilderLevel","A_buildBuff1","A_buildBuff2",
      "A_researchBase","A_coopResearch","A_researchCenterLevel","A_quickResearchLevel","A_researchEnhancementLevel",
      "A_survivor1","A_survivor2","A_survivor3","A_survivor4","A_researchBuff1","A_researchBuff2",

      // B (stored; shared fields overwritten from A)
      "B_buildBase","B_coopBuild","B_pyramidLevel","B_quickConstructionLevel","B_fastBuilderLevel","B_buildBuff1","B_buildBuff2",
      "B_researchBase","B_coopResearch","B_researchCenterLevel","B_quickResearchLevel","B_researchEnhancementLevel",
      "B_survivor1","B_survivor2","B_survivor3","B_survivor4","B_researchBuff1","B_researchBuff2"
    ];
    const state = {};
    for (const id of ids){
      const el = document.getElementById(id);
      if (!el) continue;
      if (el.type === "checkbox") state[id] = !!el.checked;
      else if (el.type === "radio") state[id] = !!el.checked;
      else state[id] = el.value;
    }
    return state;
  }

  function applyState(state){
    if (!state) return;
    for (const [id,val] of Object.entries(state)){
      const el = document.getElementById(id);
      if (!el) continue;
      if (el.type === "checkbox") el.checked = !!val;
      else if (el.type === "radio") el.checked = !!val;
      else el.value = val;
    }
  }

  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(collectState())); }catch(e){}
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      applyState(JSON.parse(raw));
    }catch(e){}
  }

  // ===== Copy / reset =====
  function copySetup(from){
    const to = from === "A" ? "B" : "A";

    // copy office selection
    const fromOffice = getSelectedOffice(from);
    document.getElementById(`${to}_officeNone`).checked = (fromOffice === "none");
    document.getElementById(`${to}_officeDev`).checked  = (fromOffice === "dev");
    document.getElementById(`${to}_officeSci`).checked  = (fromOffice === "sci");
    document.getElementById(`${to}_officeVP`).checked   = (fromOffice === "vp");

    // copy co-ops
    document.getElementById(`${to}_coopBuild`).value = document.getElementById(`${from}_coopBuild`).value;
    document.getElementById(`${to}_coopResearch`).value = document.getElementById(`${from}_coopResearch`).value;

    // if copying B->A, also copy shared fields back
    if (from === "B") {
      for (const key of SYNC_KEYS_A_TO_B){
        const a = document.getElementById(`A_${key}`);
        const b = document.getElementById(`B_${key}`);
        if (a && b) a.value = b.value;
      }
    }

    recalcAll();
  }

  function resetAll(){
    try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
    location.reload();
  }

  async function copyResultsToClipboard(){
    const A = calcSetup("A");
    const B = calcSetup("B");

    const lines = [
      `Global: VIP ${getVal("vipLevel")} | EfficientDev ${document.getElementById("efficientDev").checked ? "ON" : "OFF"} | Conqueror ${document.getElementById("conquerorBonus").checked ? "ON" : "OFF"}`,
      `Office: A=${A.officeKey}  B=${B.officeKey}`,
      `Co-ops: Build A=${getVal("A_coopBuild")}% B=${getVal("B_coopBuild")}% | Research A=${getVal("A_coopResearch")}% B=${getVal("B_coopResearch")}%`,
      `Building: A ${formatTime(A.build.final)} (+${A.build.total.toFixed(2)}%, ${speedMultiplier(A.build.total).toFixed(2)}x)`,
      `         B ${formatTime(B.build.final)} (+${B.build.total.toFixed(2)}%, ${speedMultiplier(B.build.total).toFixed(2)}x)`,
      `         Œî ${formatDeltaSeconds(B.build.final - A.build.final)} (B - A)`,
      `Research: A ${formatTime(A.research.final)} (+${A.research.total.toFixed(2)}%, ${speedMultiplier(A.research.total).toFixed(2)}x)`,
      `         B ${formatTime(B.research.final)} (+${B.research.total.toFixed(2)}%, ${speedMultiplier(B.research.total).toFixed(2)}x)`,
      `         Œî ${formatDeltaSeconds(B.research.final - A.research.final)} (B - A)`
    ];
    const text = lines.join("\n");
    try{
      await navigator.clipboard.writeText(text);
      alert("Copied results to clipboard!");
    }catch(e){
      prompt("Copy this:", text);
    }
  }

  // ===== Main =====
  function recalcAll(){
    syncAtoBSharedFields(); // keep B shared in sync with A

    const A = calcSetup("A");
    const B = calcSetup("B");

    render("A", A);
    render("B", B);

    setText("cmp_buildA", formatTime(A.build.final));
    setText("cmp_buildB", formatTime(B.build.final));
    setText("cmp_buildDelta", formatDeltaSeconds(B.build.final - A.build.final));

    setText("cmp_resA", formatTime(A.research.final));
    setText("cmp_resB", formatTime(B.research.final));
    setText("cmp_resDelta", formatDeltaSeconds(B.research.final - A.research.final));

    updateAppointmentPlanner();
    saveState();
  }

  loadState();
  lockBSharedInputs();
  recalcAll();
</script>
</body>
</html>
